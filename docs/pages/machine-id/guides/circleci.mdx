---
title: Using Machine ID With Circle CI
description: A tutorial for using Machine ID with CircleCI
---

<Details
  title="Version warning"
  opened={true}
  scope={["oss", "enterprise"]}
  scopeOnly={true}
  min="11.0"
>
  Machine ID for CircleCI is available starting from Teleport `v11.1`.
</Details>

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- A node that is a part of the Teleport cluster with
[Server Access](https://goteleport.com/docs/server-access/introduction/).
- A local workstation with `tsh` access to the cluster.
- A CircleCI project connected to a Git repository you can push to.

## Step 1/4. Determine CircleCI IDs

In order to configure the rules for which CircleCI projects will be allowed to
connect to your Teleport cluster, you must determine the ID of your CircleCI
organization and project.

### Organization ID

Open CircleCI and navigate to "Organization settings" from the navbar.
You should be presented with an interface titled "Overview" with a section
called "Organization ID". Note this value down and substitute `$ORGANIZATION_ID`
in configuration examples provided in this guide with that value.

### Project ID

Open CircleCI and select the project you wish to allow access to your Teleport
cluster. In the top right corner click "Project settings". You should be
presented with an interface titled "Overview" with a section called
"Project ID". Note this value down and substitute `$PROJECT_ID` in configuration
examples provided in this guide with that value.

## Step 2/4. Create the join token for CircleCI

```yaml
kind: token
version: v2
metadata:
  name: circleci-token
  expires: "2100-01-01T00:00:00Z"
spec:
  roles: [Bot]
  join_method: circleci
  bot_name: circleci-demo
  circleci:
    organization_id: $ORGANIZATION_ID
    allow:
      - project_id: $PROJECT_ID
```

## Step 3/4. Create a Machine ID bot

With the join token for the CircleCI project created, you now need to create a
Machine ID bot that the token will grant access to. A Machine ID bot is a
special type of Teleport user designed for access by machines, and can
authenticate using a join token rather than forms of authentication more
suitable to users (e.g such as SSO.)

For this guide, we are using the default `access` role and explicitly stating
that the bot should have access to the `root` login on hosts. In production
environments, we recommend creating a custom role for your CI/CD workflow and
ensuring that this role has no more permissions than is needed for the workflow
to complete its tasks.

Use `tctl` to create the bot:

```code
$ tctl bots add circleci-demo --roles=access --logins=root --token=circleci-token
```

## Step 4/4. Configure CircleCI workflow

Replace `tele.example.com:443` with the public-facing address of your Teleport
Proxy. Replace `my-node` with the name of the Teleport node that you wish to connect
to.

```yaml
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
jobs:
  teleport:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: "teleport"
          command: |
            ./tbot start --auth-server=tele.example.com:443 --join-method=circleci --token=circleci-token --oneshot --destination-dir=./certs --data-dir=./data
            ./tsh -i ./certs/identity --proxy tele.example.com:443 ssh root@my-node "echo $CIRCLE_BUILD_URL >> ~/circle_run_log"
workflows:
  teleport-workflow:
    jobs:
      - teleport
```

## Further steps

For more informatiom about CircleCI itself, read
[their documentation](https://circleci.com/docs/).

### Using CircleCI contexts

You can further limit which jobs within a project workflow are able to access
your Teleport cluster using CircleCI contexts. This provides more granularity
than granting access to an entire project which may also run third-party code as
part of one of the jobs in a workflow.

TODO: Explain this.
